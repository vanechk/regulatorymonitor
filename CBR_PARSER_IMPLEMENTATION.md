# Реализация парсера для Центрального банка РФ

## Описание

Добавлен специальный парсер для сайта Центрального банка Российской Федерации (cbr.ru), который использует RSS каналы для автоматического сбора новостей и пресс-релизов по ключевым словам.

## Внесенные изменения

### 1. Добавлен источник ЦБ РФ

**Файл**: `prisma/seed.ts`

```typescript
{ name: 'Центральный банк РФ', url: 'https://cbr.ru/press/', type: 'website' }
```

### 2. Создан парсер CBR с поддержкой RSS

**Файл**: `src/parsers/cbr.ts`

Парсер включает:
- **RSS каналы ЦБ РФ**:
  - `http://www.cbr.ru/rss/RssNews` - Новое на сайте (100 новостей)
  - `http://www.cbr.ru/rss/eventrss` - Новости, интервью, выступления (100 новостей)
  - `http://www.cbr.ru/rss/RssPress` - Пресс-релизы (17 новостей)
  - `http://www.cbr.ru/rss/RssCurrency` - Курсы валют (ежедневно)
- Обработку различных форматов дат (RFC 822 для RSS, русские даты для HTML)
- Фильтрацию по ключевым словам
- Fallback на HTML парсинг при недоступности RSS

### 3. Обновлен главный файл парсеров

**Файл**: `src/parsers/index.ts`

Добавлены:
- Импорт парсера CBR
- Маппинг для автоматического выбора парсера
- Обработка в функции `requestModel`

### 4. Добавлены ключевые слова

**Файл**: `prisma/seed.ts`

```typescript
'ЦБ РФ',
'Центральный банк',
```

## Функциональность парсера

### Основные возможности

1. **RSS-первый подход**: Парсер сначала пытается получить новости через RSS каналы, что обеспечивает:
   - Быструю загрузку
   - Структурированные данные
   - Актуальную информацию
   - Надежность

2. **Множественные RSS каналы**: Поддерживает 4 основных канала:
   - **Новое на сайте**: Общие новости и обновления
   - **События**: Новости, интервью, выступления
   - **Пресс-релизы**: Официальные сообщения ЦБ РФ
   - **Курсы валют**: Ежедневные курсы валют

3. **Умный парсинг дат**: Обрабатывает различные форматы:
   - RFC 822 (стандарт RSS)
   - DD.MM.YYYY
   - DD.MM.YY
   - Текстовые даты (января, февраля и т.д.)
   - Относительные даты (сегодня, вчера)

4. **Фильтрация по ключевым словам**: Новости фильтруются по заданным ключевым словам

5. **Fallback на HTML**: Если RSS недоступен, парсер использует HTML парсинг

### Структура данных

Каждая новость содержит:
- `title`: Заголовок новости
- `summary`: Краткое описание (обрезается до 500 символов)
- `publishedDate`: Дата публикации в ISO формате
- `url`: Ссылка на новость
- `subject`: Тип контента (определяется автоматически)
- `position`: "Центральный банк Российской Федерации"

### Типы контента

Парсер автоматически определяет тип контента:
- **Новости ЦБ РФ** - для общего RSS канала
- **События ЦБ РФ** - для канала событий
- **Пресс-релизы ЦБ РФ** - для пресс-релизов
- **Курсы валют ЦБ РФ** - для курсов валют

## Интеграция с системой

### Автоматический выбор парсера

Система автоматически выбирает парсер CBR для источников:
- URL содержит `cbr.ru`
- Название содержит `цб` или `центральный банк`

### Совместимость

Парсер полностью совместим с существующей системой:
- Использует те же интерфейсы (`ParserResult`, `ParsedArticle`)
- Поддерживает retry-логику
- Интегрируется с системой фильтрации
- Не нарушает работу других парсеров

## Примеры использования

### 1. Автоматический парсинг

При добавлении источника "Центральный банк РФ" система автоматически:
1. Определяет, что это ЦБ РФ
2. Выбирает парсер `parseCBR`
3. Парсит все доступные RSS каналы
4. Фильтрует новости по ключевым словам
5. Возвращает структурированные данные

### 2. Фильтрация по ключевым словам

Новости фильтруются по ключевым словам:
- "ЦБ РФ"
- "Центральный банк"
- Любые другие ключевые слова

### 3. Обработка ошибок

Парсер корректно обрабатывает ошибки:
- Сетевые проблемы
- Недоступность RSS каналов
- Fallback на HTML парсинг
- Логирование всех ошибок

## Тестирование

### Рекомендуемые тесты

1. **RSS парсинг**: Проверить, что новости корректно извлекаются из RSS
2. **Фильтрация**: Убедиться, что работает фильтрация по ключевым словам
3. **Обработка дат**: Проверить различные форматы дат
4. **Fallback**: Тестировать с недоступными RSS каналами
5. **Производительность**: Проверить скорость парсинга

### Проверка работоспособности

```bash
# Запуск seed для добавления источника и ключевых слов
npm run db:seed

# Проверка парсинга через API
curl -X POST http://localhost:3000/api/news/fetch \
  -H "Content-Type: application/json" \
  -d '{"sourceType": "website", "keywords": ["ЦБ РФ"]}'
```

## Безопасность и производительность

### Безопасность

- Использует безопасные HTTP-заголовки
- Ограничивает размер ответов
- Обрабатывает ошибки без утечки данных
- Валидирует RSS данные

### Производительность

- **RSS каналы**: Быстрая загрузка структурированных данных
- **Таймаут запросов**: 20 секунд для RSS, 15 секунд для HTML
- **Retry-логика**: 3 попытки с задержкой 2 секунды
- **Кэширование**: Результаты парсинга кэшируются

## Мониторинг и логирование

### Логирование

Парсер выводит подробные логи:
- Начало парсинга каждого RSS канала
- Количество найденных новостей в каждом канале
- Ошибки и предупреждения
- Использование fallback методов
- Общее количество найденных новостей

### Метрики

Отслеживаются:
- Успешность парсинга RSS каналов
- Время выполнения
- Количество найденных новостей по каналам
- Частота ошибок
- Эффективность fallback методов

## RSS каналы ЦБ РФ

### Доступные каналы

1. **Новое на сайте** (`/rss/RssNews`)
   - URL: `http://www.cbr.ru/rss/RssNews`
   - Объем: ~100 новостей
   - Обновление: Постоянно
   - Тип: Общие новости

2. **События** (`/rss/eventrss`)
   - URL: `http://www.cbr.ru/rss/eventrss`
   - Объем: ~100 новостей
   - Обновление: Постоянно
   - Тип: Новости, интервью, выступления

3. **Пресс-релизы** (`/rss/RssPress`)
   - URL: `http://www.cbr.ru/rss/RssPress`
   - Объем: ~17 новостей
   - Обновление: По мере появления
   - Тип: Официальные пресс-релизы

4. **Курсы валют** (`/rss/RssCurrency`)
   - URL: `http://www.cbr.ru/rss/RssCurrency`
   - Объем: 1 новость
   - Обновление: Ежедневно
   - Тип: Курсы валют

### Формат данных

Все RSS каналы используют стандарт RSS 2.0:
- `<title>` - заголовок новости
- `<description>` - описание/содержание
- `<link>` - ссылка на полную новость
- `<pubDate>` - дата публикации в формате RFC 822

## Заключение

Парсер для ЦБ РФ успешно интегрирован в систему и готов к использованию. Он обеспечивает:

✅ **RSS-первый подход** для быстрого и надежного парсинга  
✅ **4 RSS канала** с актуальными новостями  
✅ **Автоматическое определение** источников ЦБ РФ  
✅ **Умную фильтрацию** по ключевым словам  
✅ **Fallback на HTML** при недоступности RSS  
✅ **Полную совместимость** с существующей системой  
✅ **Обработку ошибок** и подробное логирование  

Система готова к парсингу новостей Центрального банка РФ без нарушения работы других функций. Новости будут автоматически появляться на дашборде после нажатия кнопки "Загрузить новости".
