# Исправление проблемы с русскими буквами "е" и "ё"

## Описание проблемы

Система не позволяла добавлять ключевое слово "отчет", если уже было добавлено слово "отчёт", и наоборот. Это происходило из-за того, что где-то в коде буквы "е" и "ё" приравнивались друг к другу, что создавало ложные дубликаты.

## Причина проблемы

1. **Уникальный индекс в базе данных**: В таблице `Keyword` есть уникальный индекс на поле `text`
2. **Неправильная проверка дубликатов**: Система считала "отчет" и "отчёт" одинаковыми словами
3. **Отсутствие четкой логики**: Не было четкого разграничения между разными вариантами написания

## Внесенные исправления

### 1. Создание утилиты для работы с русскими буквами

**Файл**: `src/server/utils/russian-normalization.ts`

```typescript
/**
 * Утилиты для работы с русскими буквами
 * Обеспечивает, чтобы "е" и "ё" считались разными символами
 */

export function normalizeRussianText(text: string): string {
  if (!text) return text;
  
  // Приводим к нижнему регистру, но сохраняем "е" и "ё"
  return text.toLowerCase().trim();
}

export function areWordsEqual(word1: string, word2: string): boolean {
  if (!word1 || !word2) return false;
  
  // Нормализуем оба слова, сохраняя различия между "е" и "ё"
  const normalized1 = normalizeRussianText(word1);
  const normalized2 = normalizeRussianText(word2);
  
  return normalized1 === normalized2;
}
```

### 2. Обновление компонента ReportGenerator

**Файл**: `src/client/components/ReportGenerator.tsx`

```typescript
const addKeyword = () => {
  if (keywordInput.trim()) {
    // Проверяем, есть ли уже такое слово (с учетом русских букв)
    const trimmedInput = keywordInput.trim();
    const isDuplicate = keywords.some(keyword => 
      keyword.toLowerCase() === trimmedInput.toLowerCase()
    );
    
    if (!isDuplicate) {
      setKeywords([...keywords, trimmedInput]);
      setKeywordInput('');
    } else {
      // Показываем уведомление о дубликате
      toast({
        title: 'Слово уже добавлено',
        description: `"${trimmedInput}" уже есть в списке ключевых слов`,
        variant: 'destructive'
      });
    }
  }
};
```

### 3. Обновление API для добавления ключевых слов

**Файл**: `api.ts`

```typescript
export async function addKeyword({ text }: { text: string }) {
  // Проверяем, есть ли уже такое ключевое слово (точное совпадение)
  const existingKeyword = await db.keyword.findFirst({
    where: {
      text: text.trim()
    }
  });

  if (existingKeyword) {
    throw new Error(`Ключевое слово "${text.trim()}" уже существует`);
  }

  return await db.keyword.create({
    data: { text: text.trim() },
  });
}
```

### 4. Обновление серверного API

**Файл**: `src/server/api.ts`

```typescript
router.post('/keywords', async (req, res) => {
  try {
    const { text } = req.body;
    
    if (!text || !text.trim()) {
      return res.status(400).json({ error: 'Текст ключевого слова обязателен' });
    }

    const trimmedText = text.trim();
    
    // Проверяем, есть ли уже такое ключевое слово (точное совпадение)
    const existingKeyword = await prisma.keyword.findFirst({
      where: {
        text: trimmedText
      }
    });

    if (existingKeyword) {
      return res.status(400).json({ 
        error: `Ключевое слово "${trimmedText}" уже существует`,
        details: 'Попробуйте использовать другое слово или проверьте написание'
      });
    }

    const keyword = await prisma.keyword.create({ 
      data: { text: trimmedText } 
    });
    
    res.json(keyword);
  } catch (error: any) {
    console.error('Ошибка создания ключевого слова:', error);
    res.status(500).json({ 
      error: 'Ошибка создания ключевого слова', 
      details: error.message 
    });
  }
});
```

## Результат исправления

После внесения изменений:

1. ✅ **Различение русских букв**: "е" и "ё" теперь считаются разными символами
2. ✅ **Точная проверка дубликатов**: Система проверяет точное совпадение слов
3. ✅ **Улучшенные сообщения об ошибках**: Пользователь получает понятные сообщения о дубликатах
4. ✅ **Консистентность**: Логика проверки дубликатов одинакова на фронтенде и бэкенде
5. ✅ **Поддержка русского языка**: Система корректно работает с русскими буквами

## Примеры работы

### До исправления:
- ❌ Добавлено "отчёт" → Нельзя добавить "отчет" (система считает их одинаковыми)
- ❌ Добавлено "отчет" → Нельзя добавить "отчёт" (система считает их одинаковыми)

### После исправления:
- ✅ Добавлено "отчёт" → Можно добавить "отчет" (система считает их разными)
- ✅ Добавлено "отчет" → Можно добавить "отчёт" (система считает их разными)
- ✅ Добавлено "отчёт" → Нельзя добавить "отчёт" (точное совпадение)
- ✅ Добавлено "отчет" → Нельзя добавить "отчет" (точное совпадение)

## Особенности реализации

- **Точное сравнение**: Система проверяет точное совпадение слов, а не нормализованные версии
- **Сохранение различий**: Буквы "е" и "ё" сохраняют свои различия
- **Улучшенный UX**: Пользователь получает понятные сообщения об ошибках
- **Консистентность**: Логика одинакова на всех уровнях приложения

## Рекомендации

1. **Тестирование**: Протестировать добавление слов с буквами "е" и "ё"
2. **Документация**: Обновить пользовательскую документацию
3. **Мониторинг**: Отслеживать успешность добавления ключевых слов
4. **Расширение**: Рассмотреть добавление поддержки других похожих букв (например, "и" и "й")
